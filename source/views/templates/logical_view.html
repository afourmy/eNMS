{% extends "base_site.html" %}

{% block title %} Logical view {% endblock title %}

{% block stylesheets %}
  {{ super() }}
  <style>
  
  .link {
    stroke: #ccc;
  }
  
  .selection {
    fill: #ADD8E6;
    stroke: #ADD8E6;
    fill-opacity: 0.3;
    stroke-opacity: 0.7;
    stroke-width: 2;
    stroke-dasharray: 5, 5;
  }
  
  .node text {
    pointer-events: none;
    font: 10px sans-serif;
  }

  div.tooltip {	
      position: absolute;			
      text-align: center;			
      width: 50px;					
      height: 40px;					
      padding: 2px;				
      font: 12px sans-serif;		
      background: lightsteelblue;	
      border: 2px;		
      border-radius: 8px;			
      pointer-events: none;			
  }
  
  </style>
{% endblock stylesheets %}

{% block content %}

{% include 'modals.html' %}
  <div class="right_col" role="main">
    <div class="row">
      <div class="col-md-12 col-sm-12 col-xs-12">
        <div class="x_panel">
          <div class="x_content">
            <!-- jQuery -->
            <script src="{{ url_for('static', filename='vendors/jquery/jquery.min.js') }}"></script>
            <script src="http://d3js.org/d3.v3.min.js"></script>

            <form method="post">
              <div class="btn-group-vertical" style="z-index:500; position: absolute; top: 10px; right:30px;">
                <button type="button" class="btn btn-primary" onclick="show_modal('filters')">Parameters</button>

                <div class="btn-group">
                <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Automation
                  <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                  <li><a onclick="show_modal('netmiko-configuration')"> Netmiko configuration </a></li>
                  <li><a onclick="show_modal('netmiko-file-transfer')"> Netmiko file transfer </a></li>
                  <li><a onclick="show_modal('napalm-getters')">NAPALM getters</a></li>
                  <li><a onclick="show_modal('napalm-configuration')">NAPALM configuration</a></li>
                  <li><a onclick="show_modal('ansible')">Ansible</a></li>
                </ul>
                </div>
              </div>
            </form>

            <div align='center' id="logical_view"></div>
            <script>
              function show_modal(modal_name){
                $(`#${modal_name}`).modal('show');
                }

              var graph = {  
                "nodes":[
                  {% for obj, properties in node_table.items() %}  
                    {  
                      "x": {{ obj.id }},
                      "y": {{ obj.id }},
                      "name": "{{ obj.name }}",
                      "img":  "{{ url_for('views_blueprint.static', filename='images/default/' + obj.subtype + '.gif') }}",
                      "selected_img": "{{ url_for('views_blueprint.static', filename='images/selected/' + obj.subtype + '.gif') }}"
                    },
                  {% endfor %}
                ],
                "links":[  
                  {% for obj, properties in link_table.items() %}
                    {  
                      "source": {{ obj['source']['id'] }} - 1,
                      "target": {{ obj['destination']['id'] }} - 1
                    },
                  {% endfor %}
                ]
              };
              
              var selected_nodes = [];
              
              // selection function
              function selectNode(d) {
                console.log(d)
                // we stop the propagation up the DOM tree so that the 
                // unselectAll event bound to the canvas is not triggered
                d3.event.stopPropagation();
                // add both the HTML and graph elements in the selected_nodes array
                selected_nodes.push([this, d]);
                d3.select(this)
                  .select('image')
                  .attr("xlink:href", d.selected_img);
              };
              
              function unselectAll() {
                d3.event.preventDefault();
                for (i = 0; i < selected_nodes.length; i++) {
                  d3.select(selected_nodes[i][0])
                    .select('image')
                    .attr("xlink:href", selected_nodes[i][1].img);
                }
                selected_nodes = [];
              };
              
              // tooltip div
              var div = d3.select("body").append("div")	
                .attr("class", "tooltip")				

              var width = 960,
                  height = 500

              var svg = d3.select("#logical_view").append("svg")
                .attr("width", width)
                .attr("height", height)
                .on("contextmenu", unselectAll);
              
              function rect(x, y, w, h) {
                return "M"+[x,y]+" l"+[w,0]+" l"+[0,h]+" l"+[-w,0]+"z";
              }
              
              var selection = svg.append("path")
                .attr("class", "selection")
                .attr("visibility", "hidden");
              
              var startSelection = function(start) {
                selection.attr("d", rect(start[0], start[0], 0, 0))
                  .attr("visibility", "visible");
              };
              
              var moveSelection = function(start, moved) {
                selection.attr("d", rect(start[0], start[1], moved[0] - start[0], moved[1] - start[1]));
              };
              
              var endSelection = function(start, end) {
                selection.attr("visibility", "hidden");
                // select all nodes in the rectangle
                d3.selectAll('.node')  //here's how you get all the nodes
                  .each(function(d) {
                    if (start[0] <= d.x && d.x <= end[0] && start[1] <= d.y && d.y <= end[1]) {
                      console.log(this, d);
                      selected_nodes.push([this, d]);
                      d3.select(this)
                        .select('image')
                        .attr("xlink:href", d.selected_img);
                    }
                  });
              };
              
              svg.on("mousedown", function() {
                var subject = d3.select(window);
                    parent = this.parentNode;
                    start = d3.mouse(parent);
                startSelection(start);
                subject
                  .on("mousemove.selection", function() {
                    moveSelection(start, d3.mouse(parent));
                  })
                  .on("mouseup.selection", function() {
                    endSelection(start, d3.mouse(parent));
                    subject
                      .on("mousemove.selection", null)
                      .on("mouseup.selection", null);
                  });
              });
              
              svg.on("touchstart", function() {
                var subject = d3.select(this);
                    parent = this.parentNode;
                    id = d3.event.changedTouches[0].identifier;
                    start = d3.touch(parent, id)
                    pos;
                  startSelection(start);
                  subject
                    .on("touchmove."+id, function() {
                      if (pos = d3.touch(parent, id)) {
                        moveSelection(start, pos);
                      }
                    })
                    .on("touchend."+id, function() {
                      if (pos = d3.touch(parent, id)) {
                        endSelection(start, pos);
                        subject
                          .on("touchmove."+id, null)
                          .on("touchend."+id, null);
                      }
                    });
              });

              var force = d3.layout.force()
                .gravity(0.05)
                .distance(100)
                .charge(-100)
                .size([width, height]);

              force
                .nodes(graph.nodes)
                .links(graph.links)
                .start();
            
              var link = svg.selectAll(".link")
                .data(graph.links)
                .enter().append("line")
                .attr("class", "link");
            
              var node = svg.selectAll(".node")
                .data(graph.nodes)
                .enter().append("g")
                .attr("class", "node")
                .call(force.drag)
                .on("click", selectNode);

              node.append("image")
                .attr("xlink:href", function(d) { return d.img; })
                .attr("x", -8)
                .attr("y", -8)
                .attr("width", 16)
                .attr("height", 16)
                
                /*
                .on("click", function(d) {		
                  div.transition()		
                    .duration(200)		
                    .style("opacity", 1);		
                  div	.html('ok')	
                    .style("left", (d3.event.pageX + 20) + "px")		
                    .style("top", (d3.event.pageY - 30) + "px");	
                  })					
                .on("mouseout", function(d) {		
                    div.transition()		
                        .duration(500)		
                        .style("opacity", 0);	
                });
                */
            
              node.append("text")
                .attr("dx", 12)
                .attr("dy", ".35em")
                .text(function(d) { return d.name });

              force.on("tick", function() {
                link.attr("x1", function(d) { return d.source.x; })
                  .attr("y1", function(d) { return d.source.y; })
                  .attr("x2", function(d) { return d.target.x; })
                  .attr("y2", function(d) { return d.target.y; });
                node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

              });

            </script>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}

{% block javascripts %}
  {{ super()}}
  <!-- jQuery Smart Wizard -->
  <script src="{{ url_for('views_blueprint.static', filename='js/smart-wizard/js/jquery.smartWizard.js') }}"></script>
  <!-- Bootstrap Datetimepicker -->
  <script src="{{ url_for('views_blueprint.static', filename='js/bootstrap-datetimepicker/bootstrap-datetimepicker.min.js') }}"></script>
  <script>
    for (n=1; n<6; n++) {
      var dates = ['start_date', 'end_date'];
      var today = new Date();
      for (var i=0; i<dates.length; i++) {
        $('#' + dates[i] + n).datetimepicker({
          format: 'DD/MM/YYYY HH:mm:ss',
          widgetPositioning: {
              horizontal: 'left',
              vertical: 'bottom'
          },
          useCurrent: false,
        });
        $('#' + dates[i] + n).data("DateTimePicker").minDate(today);
      }  
      function call_wizard(n){
        $('#wizard' + n).smartWizard();
        $('.buttonNext').addClass('btn btn-success');
        $('.buttonPrevious').addClass('btn btn-primary');
        $('.buttonFinish').addClass('btn btn-default');
      }
    }
  </script>
{% endblock javascripts %}
